i want to make a ea trading bot and i have script but i want to fix some issus
//+------------------------------------------------------------------+
//|                                                      FLIP_BOT.EA |
//|                        Generated by AMIRFXTRADE                    |
//|                           www.AMIRFXTRADE.com                            |
//+------------------------------------------------------------------+
#property strict

// Input parameters
input double InitialLots = 0.01;                  // Initial lot size
input double LotMultiplier = 1.5;                 // Lot size multiplier for Martingale
input int MaxMartingaleLevels = 7;                // Maximum number of Martingale levels
input double BaseTakeProfitPips = 10;             // Base take profit in pips
input int ATRPeriod = 14;                         // ATR period for volatility filter
input double ATRMultiplier = 1.5;                 // ATR multiplier for stop loss
input int MartingaleDistancePips = 3000;          // Distance in pips for Martingale entries
input bool EnableTrailingStop = true;             // Enable/Disable trailing stop
input int TrailingStopPips = 20;                  // Trailing stop value in pips
input bool EnableDailyLimits = true;              // Enable/Disable daily profit/loss limits
input double MaxDailyDrawdownPercent = 5.0;       // Maximum daily drawdown limit as a percentage of initial balance
input double MaxDailyProfitPercent = 5.0;         // Maximum daily profit target as a percentage of initial balance
input bool EnableTradingTime = true;              // Enable/Disable trading time window
input string StartTradingTime = "00:00";          // Start trading time (HH:MM)
input string EndTradingTime = "04:00";            // End trading time (HH:MM)
input int FastMAPeriod = 5;                       // Fast moving average period for trend
input int SlowMAPeriod = 20;                      // Slow moving average period for trend
input int RSIPeriod = 14;                         // RSI period for strategy
input double OverboughtLevel = 70;                // RSI overbought level
input double OversoldLevel = 30;                  // RSI oversold level
input bool EnableMartingale = true;               // Enable/Disable Martingale

// Global variables
double ATR;
double initialBalance;
double maxDailyDrawdown;
double maxDailyProfit;
int martingaleLevel = 0;
int MagicNumber = 123456; // Unique identifier for trades opened by this EA
datetime tradingDayStart;

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
// Initialization of Expert Advisor
   initialBalance = AccountBalance();
   maxDailyDrawdown = initialBalance * MaxDailyDrawdownPercent / 100.0;
   maxDailyProfit = initialBalance * MaxDailyProfitPercent / 100.0;
   tradingDayStart = iTime(NULL, PERIOD_D1, 0); // Start of the trading day

// Create trend labels
   CreateTrendLabels();

// Remove grid and set background color
   ChartSetInteger(0, CHART_COLOR_BACKGROUND, clrBlack);
   ChartSetInteger(0, CHART_SHOW_GRID, false);

// Create watermark
   CreateWatermark();

// Create buttons
   CreateButtons();
return(INIT_SUCCEEDED);
  }
//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
  {
// Delete the trend labels, watermark, and buttons on deinitialization
   ObjectDelete("TrendLabel1");
   ObjectDelete("TrendLabel2");
   ObjectDelete("TrendLabel3");
   ObjectDelete("TrendLabel4");
   ObjectDelete("TrendLabel5");
   ObjectDelete("Watermark");
   ObjectDelete("ButtonCloseAll");
   ObjectDelete("ButtonCloseProfit");
   ObjectDelete("ButtonCloseLoss");
  }
//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
  {
// Check trading time window
   if(EnableTradingTime && !IsWithinTradingTime())
      return;

// Calculate ATR on each tick
   CalculateATR();

// Check daily limits
   if(EnableDailyLimits && !CheckDailyLimits())
      return;

// Check if there are open positions and manage them
   ManageOpenPositions();

// Example logic to open a trade (adjust as needed)
   if(ConditionToOpenTrade())  // Replace this with your actual condition
     {
      OpenTrade();
     }

// Update trend labels
   UpdateTrendLabels();
  }
//+------------------------------------------------------------------+
//| Function to check if within trading time window                  |
//+------------------------------------------------------------------+
bool IsWithinTradingTime()
  {
   datetime currentTime = TimeCurrent();
   datetime startTime = StrToTime(TimeToStr(currentTime, TIME_DATE) + " " + StartTradingTime);
   datetime endTime = StrToTime(TimeToStr(currentTime, TIME_DATE) + " " + EndTradingTime);

   if(currentTime >= startTime && currentTime <= endTime)
     {
      return true;
     }

   return false;
  }
//+------------------------------------------------------------------+
//| Function to calculate ATR                                        |
//+------------------------------------------------------------------+
void CalculateATR()
  {
   ATR = iATR(NULL, 0, ATRPeriod, 0); // Calculate ATR and store in the global variable
   Print("Calculated ATR: ", ATR); // Print for debugging
  }
//+------------------------------------------------------------------+
//| Example function to check condition to open a trade              |
//+------------------------------------------------------------------+
bool ConditionToOpenTrade()
  {
// Replace with your actual condition to open a trade
// For example, this could be based on a moving average crossover, price action, RSI, etc.
   return true; // This always returns true, so it will open a trade on each tick (replace with real condition)
  }
//+------------------------------------------------------------------+
//| Function to open a trade                                         |
//+------------------------------------------------------------------+
void OpenTrade()
  {
   double lotSize = InitialLots; // Initial lot size
   double takeProfit = BaseTakeProfitPips * Point; // Base take profit in points
   double stopLoss = CalculateStopLoss(); // Calculate stop loss based on ATR

   double price = Ask; // Example price for a buy order
// Check for Martingale entry conditions at specified intervals
               double requiredPrice = OrderOpenPrice() - ((martingaleLevel + 1) * MartingaleDistancePips * Point);
               if(Bid <= requiredPrice && martingaleLevel < MaxMartingaleLevels)
                 {
                  OpenMartingaleTrade();
                 }
              }
           }
        }
     }
  }
//+------------------------------------------------------------------+
//| Function to open Martingale trade                                |
//+------------------------------------------------------------------+
void OpenMartingaleTrade()
  {
   double lotSize = CalculateLotSize(); // Calculate lot size based on Martingale
   double stopLoss = CalculateStopLoss(); // Calculate stop loss based on ATR
   double takeProfit = CalculateMartingaleTakeProfit(); // Calculate dynamic take profitint ticket = OrderSend(Symbol(), OP_BUY, lotSize, Ask, 3, stopLoss, Ask + takeProfit, "FLIP_BOT", MagicNumber, 0, Blue);
   if(ticket < 0)
     {
      Print("Martingale OrderSend failed with error #", GetLastError());
     }
   else
     {
      martingaleLevel++;
      Print("Martingale trade opened with ticket #", ticket);
     }
  }
//+------------------------------------------------------------------+
//| Function to calculate dynamic take profit for Martingale trades  |
//+------------------------------------------------------------------+
double CalculateMartingaleTakeProfit()
  {
   double totalLots = 0;
   double totalCost = 0;
   for(int i = 0; i < OrdersTotal(); i++)
     {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
        {
         if(OrderMagicNumber() == MagicNumber && OrderType() == OP_BUY)
           {
            totalLots += OrderLots();
            totalCost += OrderLots() * OrderOpenPrice();
           }
        }
     }
   double avgPrice = totalCost / totalLots;
   double takeProfitPrice = avgPrice + (BaseTakeProfitPips * Point);
   return takeProfitPrice - Ask;
  }
//+------------------------------------------------------------------+
//| Function to calculate lot size for Martingale trade              |
//+------------------------------------------------------------------+
double CalculateLotSize()
  {
   double lotSize = InitialLots * MathPow(LotMultiplier, martingaleLevel);
   return lotSize;
  }
//+------------------------------------------------------------------+
//| Function to calculate take profit                                |
//+------------------------------------------------------------------+
double CalculateTakeProfit()
  {
   return BaseTakeProfitPips * Point;
  }
//+------------------------------------------------------------------+
//| Function to create trend labels                                  |
//+------------------------------------------------------------------+
void CreateTrendLabels()
  {
// Create trend labels
   for(int i = 1; i <= 5; i++)
     {
      string trendLabelName = "TrendLabel" + IntegerToString(i);
      if(!ObjectCreate(0, trendLabelName, OBJ_LABEL, 0, 0, 0))
        {
         Print("Error creating trend label: ", GetLastError());
         continue;
        }
      ObjectSetInteger(0, trendLabelName, OBJPROP_CORNER, CORNER_LEFT_UPPER);
      ObjectSetInteger(0, trendLabelName, OBJPROP_XDISTANCE, 20);
      ObjectSetInteger(0, trendLabelName, OBJPROP_YDISTANCE, 20 + (i - 1) * 15);
      ObjectSetInteger(0, trendLabelName, OBJPROP_COLOR, clrWhite);
      ObjectSetInteger(0, trendLabelName, OBJPROP_FONTSIZE, 10);
      ObjectSetInteger(0, trendLabelName, OBJPROP_SELECTABLE, false);
      ObjectSetInteger(0, trendLabelName, OBJPROP_HIDDEN, true);
      ObjectSetString(0, trendLabelName, OBJPROP_TEXT, "Trend " + IntegerToString(i));
     }
  }
//+------------------------------------------------------------------+
//| Function to update trend labels                                  |
//+------------------------------------------------------------------+
void UpdateTrendLabels()
  {
// Update trend labels with current market conditions
   for(int i = 1; i <= 5; i++)
     {
      string trendLabelName = "TrendLabel" + IntegerToString(i);
      string trendText = "Trend " + IntegerToString(i) + ": " + DoubleToString(iMA(NULL, 0, i * 10, 0, MODE_SMA, PRICE_CLOSE, 0), 2);
      ObjectSetString(0, trendLabelName, OBJPROP_TEXT, trendText);
     }
  }
//+------------------------------------------------------------------+
//| Function to create watermark                                     |
//+------------------------------------------------------------------+
void CreateWatermark()
  {
   string watermark = "AMIRFXTRADE";
   string watermarkName = "Watermark";

   if(!ObjectCreate(0, watermarkName, OBJ_LABEL, 0, 0, 0))
     {
      Print("Error creating watermark: ", GetLastError());
      return;
     }
ObjectSetInteger(0, name, OBJPROP_CORNER, CORNER_LEFT_UPPER);
   ObjectSetInteger(0, name, OBJPROP_XDISTANCE, x);
   ObjectSetInteger(0, name, OBJPROP_YDISTANCE, y);
   ObjectSetInteger(0, name, OBJPROP_XSIZE, width); // Use OBJPROP_XSIZE instead of OBJPROP_WIDTH
   ObjectSetInteger(0, name, OBJPROP_YSIZE, height); // Use OBJPROP_YSIZE instead of OBJPROP_HEIGHT
   ObjectSetInteger(0, name, OBJPROP_COLOR, btnColor);
   ObjectSetInteger(0, name, OBJPROP_HIDDEN, true);
   ObjectSetInteger(0, name, OBJPROP_FONTSIZE, 10);
   ObjectSetInteger(0, name, OBJPROP_BORDER_TYPE, BORDER_RAISED);
   ObjectSetString(0, name, OBJPROP_TEXT, label);
  }
//+------------------------------------------------------------------+
//| Function to handle button clicks                                 |
//+------------------------------------------------------------------+
void OnChartEvent(const int id, const long &lparam, const double &dparam, const string &sparam)
  {
   if(id == CHARTEVENT_OBJECT_CLICK)
     {
      if(sparam == "ButtonCloseAll")
        {
         CloseAllTrades();
        }
      else
         if(sparam == "ButtonCloseProfit")
           {
            CloseAllProfitTrades();
           }
         else
            if(sparam == "ButtonCloseLoss")
              {
               CloseAllLossTrades();
              }
     }
  }
//+------------------------------------------------------------------+
//| Function to close all trades                                     |
//+------------------------------------------------------------------+
void CloseAllTrades()
  {
   for(int i = OrdersTotal() - 1; i >= 0; i--)
     {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
        {
         if(OrderMagicNumber() == MagicNumber)
           {
            if(!OrderClose(OrderTicket(), OrderLots(), Bid, 3, clrRed))
              {
               Print("OrderClose failed with error #", GetLastError());
              }
           }
        }
     }
  }
//+------------------------------------------------------------------+
//| Function to close all profitable trades                          |
//+------------------------------------------------------------------+
void CloseAllProfitTrades()
  {
   for(int i = OrdersTotal() - 1; i >= 0; i--)
     {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
        {
         if(OrderMagicNumber() == MagicNumber && OrderProfit() > 0)
           {
            if(!OrderClose(OrderTicket(), OrderLots(), Bid, 3, clrGreen))
              {
               Print("OrderClose failed with error #", GetLastError());
              }
           }
        }
     }
  }
//+------------------------------------------------------------------+
//| Function to close all losing trades                              |
//+------------------------------------------------------------------+
void CloseAllLossTrades()
  {
   for(int i = OrdersTotal() - 1; i >= 0; i--)
     {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
        {
         if(OrderMagicNumber() == MagicNumber && OrderProfit() < 0)
           {
            if(!OrderClose(OrderTicket(), OrderLots(), Bid, 3, clrYellow))
              {
               Print("OrderClose failed with error #", GetLastError());
              }
           }
        }
     }
  }
//+------------------------------------------------------------------+


evry thing with the bot is fine just put a time filter for the news so the bot dont work in news  time 

and it stop taking martingel after the tp hit from the first martingel and make it right and it should take martingel all the time and dont let it be like this and make the tps in martingel move to the last tp of the laiyr and move allnof them to that 

<!---
erfan9776/erfan9776 is a ✨ special ✨ repository because its `README.md` (this file) appears on your GitHub profile.
You can click the Preview link to take a look at your changes.
--->
